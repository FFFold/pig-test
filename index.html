<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æµ‹æµ‹ä½ æ˜¯ä¸æ˜¯çŒª - å£°çº¹ç‰ˆ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#FFB6C1', // æµ…ç²‰è‰²
            secondary: '#F5F5F5', // æµ…ç°è‰²
            accent: '#FF69B4', // äº®ç²‰è‰²
          },
          fontFamily: {
            sans: ['Arial Rounded MT Bold', 'Avenir', 'Helvetica', 'Arial', 'sans-serif'],
          },
          animation: {
            'bounce-slow': 'bounce 2s infinite',
            'pulse-fast': 'pulse 1s infinite',
            'wave': 'wave 1.5s linear infinite',
          },
          keyframes: {
            wave: {
              '0%': { transform: 'scale(1)', opacity: '1' },
              '100%': { transform: 'scale(1.5)', opacity: '0' },
            }
          }
        }
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .text-shadow {
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .text-shadow-lg {
        text-shadow: 0 4px 8px rgba(0,0,0,0.12), 0 2px 4px rgba(0,0,0,0.08);
      }
    }
    
    body {
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }

    .result-card-area {
        transition: all 0.5s ease;
    }
    
    @keyframes float {
      0% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
      100% { transform: translateY(0px); }
    }
    
    .float-animation {
      animation: float 3s ease-in-out infinite;
    }
    
    .mic-container {
      position: relative;
      width: 160px;
      height: 160px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background: white;
      box-shadow: 0 10px 25px rgba(255, 182, 193, 0.5);
      cursor: pointer;
      transition: all 0.3s;
    }

    .mic-container:active {
        transform: scale(0.95);
    }

    .mic-wave {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        border: 2px solid #FF69B4;
        opacity: 0;
        pointer-events: none;
    }

    .recording .mic-wave {
        animation: wave 1.5s linear infinite;
    }

    .recording .mic-wave:nth-child(2) {
        animation-delay: 0.5s;
    }

    .hidden { display: none !important; }
  </style>
</head>
<body class="bg-secondary min-h-screen flex flex-col items-center justify-center p-4">
  <div class="container max-w-md mx-auto text-center">
    <h1 class="text-4xl md:text-5xl font-bold mb-6 text-primary text-shadow-lg">
      æµ‹æµ‹ä½ æ˜¯ä¸æ˜¯çŒª <span class="text-accent">ğŸ·</span>
    </h1>
    <p class="text-gray-500 mb-6 font-medium">å£°çº¹é‰´å®šç‰ˆ</p>
    
    <div class="bg-white rounded-3xl shadow-lg p-6 mb-8 transform transition-all duration-300 hover:shadow-xl">
      
      <div id="test-area" class="mb-6 flex flex-col items-center">
        
        <div id="mic-btn" class="mic-container mb-6 group">
            <div class="mic-wave"></div>
            <div class="mic-wave"></div>
            <svg id="mic-icon" class="w-16 h-16 text-primary group-hover:text-accent transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
            </svg>
            <div id="recording-icon" class="hidden flex items-end gap-1 h-8">
                <div class="w-1.5 bg-accent h-3 animate-[bounce_1s_infinite]"></div>
                <div class="w-1.5 bg-accent h-6 animate-[bounce_1.2s_infinite]"></div>
                <div class="w-1.5 bg-accent h-4 animate-[bounce_0.8s_infinite]"></div>
                <div class="w-1.5 bg-accent h-7 animate-[bounce_1.5s_infinite]"></div>
                <div class="w-1.5 bg-accent h-3 animate-[bounce_1.1s_infinite]"></div>
            </div>
        </div>
        
        <h3 id="status-text" class="text-xl font-bold text-gray-700 mb-2">ç‚¹å‡»éº¦å…‹é£</h3>
        <p id="instruction" class="text-gray-500">æ¨¡ä»¿çŒªå«å£°ï¼Œç³»ç»Ÿå°†åˆ†æéŸ³é¢‘é¢‘ç‡</p>
        <p id="freq-display" class="text-accent font-mono text-sm mt-2 opacity-0 h-5">0 Hz</p>
      </div>
      
      <div id="result-area" class="hidden result-card-area">
        <div class="bg-primary/10 rounded-2xl p-6 flex flex-col items-center justify-center min-h-[16rem] mb-6">
          <img id="result-emoji" class="w-24 h-24 mb-4 float-animation" src="" alt="çŒª">
          <h2 id="result-title" class="text-2xl font-bold text-gray-800 mb-2">ç»“æœ</h2>
          <div class="bg-white/50 px-3 py-1 rounded-full text-xs text-primary mb-3 font-mono">
            æ£€æµ‹é¢‘ç‡: <span id="result-freq">0</span> Hz
          </div>
          <p id="result-description" class="text-gray-600 font-medium mb-2"></p>
          <p id="result-analysis" class="text-gray-500 text-sm italic"></p>
        </div>
        
        <button id="retest-button" class="bg-primary text-white py-3 px-8 rounded-full font-bold shadow-md hover:bg-primary/80 transition-all active:scale-95">
          å†æµ‹ä¸€æ¬¡
        </button>
      </div>
    </div>
    
    <footer class="text-gray-400 text-xs">
      <p>æ³¨æ„ï¼šè¯·å…è®¸æµè§ˆå™¨ä½¿ç”¨éº¦å…‹é£æƒé™</p>
      <p class="mt-1">Based on Frequency Analysis</p>
    </footer>
  </div>

  <script>
    // --- çŒªçŒªæ•°æ®åº“ (æŒ‰é¢‘ç‡ç‰¹å¾åˆ†ç±») ---
    // é€»è¾‘ï¼š
    // Low (<300Hz): ç²—çŠ·ã€é‡æ€§
    // Mid (300-800Hz): äººç±»ã€æ™®é€šã€æ··åˆ
    // High (>800Hz): å¯çˆ±ã€å°–å«ã€é­”æ³•
    
    const pigDatabase = {
      low: [
        { id: "wild-boar", name: "é‡çŒª", emoji: "ğŸ—", desc: "å—“éŸ³ä½æ²‰ç²—çŠ·ï¼Œå……æ»¡é‡æ€§ï¼", analysis: "ä½ çš„å£°çº¿å……æ»¡åŠ›é‡ï¼Œåƒé‡çŒªä¸€æ ·å‹‡çŒ›åˆšå¼ºï¼Œé‡åˆ°å›°éš¾ä»ä¸é€€ç¼©ã€‚" },
        { id: "black-pig", name: "å°é»‘çŒª", emoji: "ğŸ–", desc: "æ·±æ²‰å†…æ•›çš„å“¼å“¼å£°ã€‚", analysis: "ä½æ²‰çš„å—“éŸ³é€éœ²å‡ºä½ ç‹¬ç‰¹çš„é­…åŠ›ï¼Œå¤–è¡¨ä½è°ƒä½†å†…å¿ƒä¸°å¯Œã€‚" },
        { id: "demon-pig", name: "æ¶é­”çŒª", emoji: "ğŸ˜ˆğŸ·", desc: "æ¥è‡ªåœ°ç‹±çš„ä½è¯­...", analysis: "ä½ çš„å£°éŸ³é‡Œè—ç€ååçš„å¯çˆ±ï¼Œå–œæ¬¢æ¶ä½œå‰§ï¼Œä½†ä¹Ÿå……æ»¡æ´»åŠ›ã€‚" },
        { id: "boss-pig", name: "çŒªè€æ¿", emoji: "ğŸ•¶ï¸ğŸ·", desc: "å……æ»¡å¨ä¸¥çš„å’³å—½å£°ã€‚", analysis: "å¤©ç”Ÿçš„é¢†å¯¼è€…ï¼Œå£°éŸ³æµ‘åšæœ‰åŠ›ï¼Œè®©äººå¿ä¸ä½æƒ³å¬ä»æŒ‡æŒ¥ã€‚" },
        { id: "skeleton-pig", name: "éª·é«…çŒª", emoji: "ğŸ’€ğŸ·", desc: "æ²¡æœ‰å£°å¸¦çš„æ‘©æ“¦å£°ã€‚", analysis: "ç‹¬ç‰¹çš„é…·åŠ²ï¼Œå¤–è¡¨å†·é…·å†…å¿ƒæ¸©æš–ï¼Œéå¸¸æœ‰ä¸ªæ€§ã€‚" }
      ],
      mid: [
        { id: "pig", name: "æ™®é€šå°çŒª", emoji: "ğŸ·", desc: "æ ‡å‡†çš„çŒªå«å£°ã€‚", analysis: "æ€§æ ¼æ¸©å’Œï¼Œå®¹æ˜“æ»¡è¶³ï¼ŒçŸ¥é“å¦‚ä½•äº«å—ç”Ÿæ´»çš„ç¾å¥½ã€‚" },
        { id: "human", name: "äººç±»", emoji: "ğŸ‘¤", desc: "æ£€æµ‹åˆ°äººç±»è¯­è¨€é¢‘ç‡ã€‚", analysis: "ä¿æŒç€äººç±»çš„ç†æ™ºï¼Ÿä¸ï¼Œä¹Ÿè®¸åªæ˜¯ä¼ªè£…å¾—å¾ˆå¥½çš„çŒªäººã€‚" },
        { id: "pig-human", name: "çŒªäºº", emoji: "ğŸ·ğŸ‘¤", desc: "åŠäººåŠçŒªçš„å¥‡å¦™é¢‘ç‡ã€‚", analysis: "å…¼å…·çŒªçš„å¯çˆ±å’Œäººçš„æ™ºæ…§ï¼Œæƒ…æ„Ÿä¸°å¯Œã€‚" },
        { id: "black-white-pig", name: "é»‘ç™½çŒª", emoji: "âš«âšªğŸ·", desc: "å¹³è¡¡çš„å£°çº¿ã€‚", analysis: "æ€§æ ¼çŸ›ç›¾è€Œç»Ÿä¸€ï¼Œæ—¢ä¸¥è‚ƒåˆæ´»æ³¼ã€‚" },
        { id: "pork-skewer", name: "çŒªè‚‰ä¸²", emoji: "ğŸ¢", desc: "æ»‹æ»‹å†’æ²¹çš„å£°éŸ³ï¼Ÿ", analysis: "æ€§æ ¼å¼€æœ—ï¼Œåƒç¾é£Ÿä¸€æ ·å¸¦ç»™äººå¿«ä¹ã€‚" },
        { id: "zhuge-liang", name: "çŒªè‘›äº®", emoji: "ğŸ·ğŸ§ ", desc: "å……æ»¡æ™ºæ…§çš„å“¼é¸£ã€‚", analysis: "èªæ˜ç»é¡¶ï¼Œå£°éŸ³é‡Œéƒ½é€ç€æœºæ™ºå’Œè°‹ç•¥ã€‚" }
      ],
      high: [
        { id: "pig-cat", name: "çŒªå’ª", emoji: "ğŸ·ğŸ±", desc: "åƒçŒ«ä¸€æ ·çš„æ’’å¨‡å£°ã€‚", analysis: "å…¼å…·çŒªçš„æ†¨åšå’ŒçŒ«çš„ä¼˜é›…ï¼Œè¶…çº§æƒ¹äººå–œçˆ±ã€‚" },
        { id: "magic-pig", name: "é­”æ³•å°‘çŒª", emoji: "ğŸª„ğŸ·", desc: "é«˜é¢‘é­”æ³•åŸå”±ï¼", analysis: "æƒ³è±¡åŠ›ä¸°å¯Œï¼Œæ€»æ˜¯èƒ½å¸¦æ¥æƒŠå–œï¼Œå£°éŸ³å……æ»¡ç©¿é€åŠ›ã€‚" },
        { id: "heaven-pig", name: "å¤©å ‚çŒª", emoji: "ğŸ˜‡ğŸ·", desc: "ç©ºçµçš„ç¦éŸ³ã€‚", analysis: "å¿ƒçµçº¯æ´ï¼Œå£°éŸ³åƒå¤©ä½¿ä¸€æ ·æ²»æ„ˆäººå¿ƒã€‚" },
        { id: "explosive-pig", name: "çˆ†ç ´å°çŒª", emoji: "ğŸ’£ğŸ·", desc: "å°–é”çš„å¼•ä¿¡å£°ï¼", analysis: "çƒ­æƒ…ä¼¼ç«ï¼Œç²¾åŠ›å……æ²›ï¼Œä½ çš„å£°éŸ³èƒ½ç‚¹ç‡ƒå…¨åœºæ°”æ°›ã€‚" },
        { id: "crystal-pig", name: "æ°´æ™¶çŒª", emoji: "ğŸ’ğŸ·", desc: "æ¸…è„†æ‚¦è€³ã€‚", analysis: "æ‹¥æœ‰çº¯æ´é€æ˜çš„å¿ƒçµï¼Œæ°”è´¨é«˜é›…ã€‚" },
        { id: "doll-pig", name: "ç©å¶çŒª", emoji: "ğŸ§¸ğŸ·", desc: "æŒ‰å‹å‘å‡ºçš„å±å±å£°ã€‚", analysis: "å¯çˆ±åˆ°çŠ¯è§„ï¼Œè®©äººå¿ä¸ä½æƒ³è¦ä¿æŠ¤ä½ ã€‚" }
      ]
    };

    // DOM å…ƒç´ 
    const micBtn = document.getElementById('mic-btn');
    const micIcon = document.getElementById('mic-icon');
    const recordingIcon = document.getElementById('recording-icon');
    const statusText = document.getElementById('status-text');
    const instruction = document.getElementById('instruction');
    const freqDisplay = document.getElementById('freq-display');
    
    const testArea = document.getElementById('test-area');
    const resultArea = document.getElementById('result-area');
    const resultEmoji = document.getElementById('result-emoji');
    const resultTitle = document.getElementById('result-title');
    const resultDesc = document.getElementById('result-description');
    const resultAnalysis = document.getElementById('result-analysis');
    const resultFreq = document.getElementById('result-freq');
    const retestBtn = document.getElementById('retest-button');

    // éŸ³é¢‘ä¸Šä¸‹æ–‡å˜é‡
    let audioContext;
    let analyser;
    let microphone;
    let animationId;
    let isRecording = false;

    // äº‹ä»¶ç›‘å¬
    micBtn.addEventListener('click', toggleRecording);
    retestBtn.addEventListener('click', resetTest);

    // åˆ‡æ¢å½•éŸ³çŠ¶æ€
    async function toggleRecording() {
      if (isRecording) return; // æ­£åœ¨å½•éŸ³ä¸­ç‚¹å‡»æ— æ•ˆ
      
      try {
        // åˆå§‹åŒ– AudioContext (å¿…é¡»åœ¨ç”¨æˆ·äº¤äº’å)
        if (!audioContext) {
          audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }

        // è·å–éº¦å…‹é£æƒé™
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        
        startAnalysis(stream);

      } catch (err) {
        console.error('éº¦å…‹é£è·å–å¤±è´¥:', err);
        alert('æ— æ³•è·å–éº¦å…‹é£æƒé™ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨è®¾ç½®æˆ–ä½¿ç”¨ HTTPS åè®®è®¿é—®ã€‚');
        statusText.textContent = "æƒé™è·å–å¤±è´¥";
      }
    }

    // å¼€å§‹åˆ†æ
    function startAnalysis(stream) {
      isRecording = true;
      
      // UI æ›´æ–°
      micBtn.classList.add('recording');
      micIcon.classList.add('hidden');
      recordingIcon.classList.remove('hidden');
      statusText.textContent = "æ­£åœ¨æ”¶å¬çŒªå«...";
      statusText.classList.add('text-accent');
      instruction.textContent = "è¯·å°½æƒ…åšå«å§ï¼";
      freqDisplay.classList.remove('opacity-0');

      // éŸ³é¢‘èŠ‚ç‚¹è¿æ¥
      analyser = audioContext.createAnalyser();
      analyser.fftSize = 2048; // ç²¾åº¦
      microphone = audioContext.createMediaStreamSource(stream);
      microphone.connect(analyser);

      const bufferLength = analyser.frequencyBinCount;
      const dataArray = new Uint8Array(bufferLength);
      
      let maxFreqAccumulator = 0;
      let samplesCount = 0;
      let detectedFreqs = [];

      // å®æ—¶åˆ†æå¾ªç¯
      const analyzeLoop = () => {
        if (!isRecording) return;
        
        analyser.getByteFrequencyData(dataArray);

        // å¯»æ‰¾å½“å‰å¸§æœ€å¤§éŸ³é‡çš„é¢‘ç‡ç´¢å¼•
        let maxVal = -1;
        let maxIndex = -1;
        
        // ç®€å•çš„å™ªå£°é—¨é™ï¼Œè¿‡æ»¤æ‰å¤ªå°çš„å£°éŸ³
        for (let i = 0; i < bufferLength; i++) {
          if (dataArray[i] > maxVal && dataArray[i] > 100) { // é˜ˆå€¼ 100
            maxVal = dataArray[i];
            maxIndex = i;
          }
        }

        if (maxIndex !== -1) {
          // è®¡ç®—é¢‘ç‡: index * sampleRate / fftSize
          const nyquist = audioContext.sampleRate / 2;
          const frequency = maxIndex * (audioContext.sampleRate / analyser.fftSize);
          
          detectedFreqs.push(frequency);
          freqDisplay.textContent = Math.round(frequency) + " Hz";
        }

        animationId = requestAnimationFrame(analyzeLoop);
      };

      analyzeLoop();

      // 3ç§’ååœæ­¢å½•éŸ³å¹¶å‡ºç»“æœ
      setTimeout(() => {
        stopRecording(stream, detectedFreqs);
      }, 3000);
    }

    // åœæ­¢å½•éŸ³å¹¶å¤„ç†ç»“æœ
    function stopRecording(stream, freqs) {
      isRecording = false;
      cancelAnimationFrame(animationId);
      
      // å…³é—­æµ
      stream.getTracks().forEach(track => track.stop());
      micBtn.classList.remove('recording');
      
      // è®¡ç®—å¹³å‡/ä¸»é¢‘ç‡
      let finalFreq = 0;
      if (freqs.length > 0) {
        // è¿‡æ»¤æ‰æç«¯çš„ 0 æˆ–å™ªå£°ï¼Œå–ä¸­ä½æ•°æˆ–å¹³å‡å€¼
        // è¿™é‡Œç®€åŒ–å–å¹³å‡
        const sum = freqs.reduce((a, b) => a + b, 0);
        finalFreq = Math.round(sum / freqs.length);
      }

      // å¦‚æœæ²¡æœ‰æ£€æµ‹åˆ°æœ‰æ•ˆå£°éŸ³ï¼ˆå¤ªå®‰é™ï¼‰
      if (finalFreq === 0) {
         statusText.textContent = "å£°éŸ³å¤ªå°å•¦";
         instruction.textContent = "è¯·å¤§å£°ä¸€ç‚¹å†è¯•ä¸€æ¬¡";
         micIcon.classList.remove('hidden');
         recordingIcon.classList.add('hidden');
         statusText.classList.remove('text-accent');
         return;
      }

      showResult(finalFreq);
    }

    // æ˜¾ç¤ºç»“æœ
    function showResult(freq) {
      // 1. ç¡®å®šç±»åˆ«
      let category = 'mid';
      if (freq < 300) category = 'low';
      else if (freq > 800) category = 'high';
      
      // 2. ä»ç±»åˆ«ä¸­éšæœºæŠ½å–ç»“æœ
      const pool = pigDatabase[category];
      const result = pool[Math.floor(Math.random() * pool.length)];

      // 3. æ¸²æŸ“ DOM
      // å›¾ç‰‡å›é€€é€»è¾‘ï¼šå¦‚æœæ²¡æœ‰çœŸå®å›¾ç‰‡ï¼Œå°è¯•åŠ è½½æˆ–ä½¿ç”¨ emoji ä½œä¸ºå ä½
      // æ­¤å¤„ä¸ºäº†å…¼å®¹åŸä»£ç ç»“æ„ï¼Œå‡è®¾ image ç›®å½•ä¸‹æœ‰ id.pngï¼Œå¦åˆ™æ˜¾ç¤ºé»˜è®¤
      resultEmoji.src = `./image/${result.id}.png`; 
      resultEmoji.onerror = function() {
         // å›¾ç‰‡åŠ è½½å¤±è´¥æ—¶ï¼Œæ˜¾ç¤º emoji (è¿™é‡Œç”¨ç®€å•çš„æ›¿æ¢é€»è¾‘ï¼Œå®é™…å¯ä»¥ç”¨ Canvas ç»˜åˆ¶ emoji)
         this.style.display = 'none';
         const placeholder = document.createElement('div');
         placeholder.textContent = result.emoji;
         placeholder.className = 'text-6xl mb-4 float-animation';
         this.parentNode.insertBefore(placeholder, this);
      };

      resultTitle.textContent = result.name;
      resultDesc.textContent = result.desc;
      resultAnalysis.textContent = result.analysis;
      resultFreq.textContent = freq;

      // 4. åˆ‡æ¢æ˜¾ç¤º
      testArea.classList.add('hidden');
      resultArea.classList.remove('hidden');
      playSound(category);
    }

    function resetTest() {
      resultArea.classList.add('hidden');
      testArea.classList.remove('hidden');
      
      // é‡ç½® UI
      micIcon.classList.remove('hidden');
      recordingIcon.classList.add('hidden');
      statusText.textContent = "ç‚¹å‡»éº¦å…‹é£";
      statusText.classList.remove('text-accent');
      instruction.textContent = "æ¨¡ä»¿çŒªå«å£°ï¼Œç³»ç»Ÿå°†åˆ†æéŸ³é¢‘é¢‘ç‡";
      freqDisplay.textContent = "0 Hz";
      freqDisplay.classList.add('opacity-0');
      
      // æ¢å¤å›¾ç‰‡æ˜¾ç¤ºï¼ˆå¦‚æœä¹‹å‰è¢« emoji æ›¿æ¢äº†ï¼‰
      if (resultEmoji.style.display === 'none') {
        resultEmoji.style.display = 'block';
        const prevEmoji = resultEmoji.previousSibling;
        if(prevEmoji && prevEmoji.nodeType === 1) prevEmoji.remove();
      }
    }

    // ç®€å•çš„éŸ³æ•ˆåé¦ˆ
    function playSound(type) {
      if (!audioContext) return;
      const osc = audioContext.createOscillator();
      const gain = audioContext.createGain();
      osc.connect(gain);
      gain.connect(audioContext.destination);

      const now = audioContext.currentTime;
      
      if (type === 'high') {
        osc.frequency.setValueAtTime(800, now);
        osc.frequency.exponentialRampToValueAtTime(1200, now + 0.1);
      } else if (type === 'low') {
        osc.frequency.setValueAtTime(200, now);
        osc.frequency.linearRampToValueAtTime(100, now + 0.3);
      } else {
        osc.frequency.setValueAtTime(400, now);
        osc.frequency.setValueAtTime(600, now + 0.1);
      }
      
      gain.gain.setValueAtTime(0.1, now);
      gain.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
      
      osc.start(now);
      osc.stop(now + 0.5);
    }

  </script>
</body>
</html>